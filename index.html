<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestione Sale Operatorie — Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --grid: #e9ecef; }
    body { background: #f8f9fa; }
    .time-cell { width: 70px; font-weight: 600; background: #fdfdfd; }
    .slot { position: relative; height: 40px; }
    .case-block {
      position: absolute; inset: 2px; border-radius: .5rem;
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; cursor: pointer; text-align:center; padding: .25rem;
    }
    .case-cont { border: 1px dashed rgba(0,0,0,.2); background: rgba(0,0,0,.03); }
    .case-sala1 { background: rgba(13,110,253,.15); border: 1px solid rgba(13,110,253,.4); color: #0b3a59; }
    .case-sala2 { background: rgba(220,53,69,.15); border: 1px solid rgba(220,53,69,.4); color: #721c24; }
    .case-sala3 { background: rgba(255,193,7,.15); border: 1px solid rgba(255,193,7,.4); color: #856404; }
    .case-sala4 { background: rgba(40,167,69,.15); border: 1px solid rgba(40,167,69,.4); color: #155724; }
    .case-sala5 { background: rgba(111,66,193,.15); border: 1px solid rgba(111,66,193,.4); color: #3d1769; }
    .table-sticky thead th { position: sticky; top: 0; background: #fff; z-index: 2; }
    .kpi-card { text-align: center; }
    .kpi-value { font-size: 1.6rem; font-weight: 700; }
    .person-icon { font-size: 1.1rem; margin-right: .3rem; }
    .offcanvas-footer { background: #f8f9fa; }
    footer { padding: 1rem 0; color: #6c757d; }
  </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid d-flex justify-content-center position-relative">

            <!-- Titolo centrato -->
            <span class="navbar-brand mx-auto">Gestione Sale Operatorie · Dashboard</span>

            <!-- Testo a destra -->
            <span class="text-white-50 position-absolute end-0 me-3">
                Giornata: <span id="dayLabel"></span>
            </span>
        </div>
    </nav>


    <div class="container-fluid py-3">
        <!-- KPI CARDS -->
        <div class="row g-3 mb-3">
            <div class="col-md-3"><div class="card kpi-card shadow-sm"><div class="card-body"><h6>Sale Occupate</h6><div class="kpi-value" id="kpiSale">0/5</div></div></div></div>
            <div class="col-md-3"><div class="card kpi-card shadow-sm"><div class="card-body"><h6>Pazienti Oggi</h6><div class="kpi-value" id="kpiPazienti">0</div></div></div></div>
            <div class="col-md-3"><div class="card kpi-card shadow-sm"><div class="card-body"><h6>Interventi Completati</h6><div class="kpi-value" id="kpiCompletati">0</div></div></div></div>
            <div class="col-md-3"><div class="card kpi-card shadow-sm"><div class="card-body"><h6>In Ritardo</h6><div class="kpi-value text-danger" id="kpiRitardo">0</div></div></div></div>
        </div>

        <div class="row g-3">
            <!-- PLANNER -->
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-2">Planning Orario — 08:00 → 20:00</h5>
                        <div class="table-responsive table-sticky">
                            <table class="table table-sm align-middle mb-0" id="scheduleTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Orario</th>
                                        <th data-sala="1">S 1 · Ortopedia</th>
                                        <th data-sala="2">S 2 · Cardioch.</th>
                                        <th data-sala="3">S 3 · Neuroch.</th>
                                        <th data-sala="4">S 4 · Chir. Gen.</th>
                                        <th data-sala="5">S 5 · Urol.</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FORM + ASSEGNAZIONI -->
            <div class="col-lg-4">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <h5 class="card-title mb-0">Nuovo Intervento</h5>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAll">Svuota giornata</button>
                        </div>
                        <hr>
                        <form id="surgeryForm" class="row g-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label" for="patientFirstName">Nome Paziente</label>
                                <input id="patientFirstName" class="form-control" required />
                                <label class="form-label" for="patientLastName">Cognome Paziente</label>
                                <input id="patientLastName" class="form-control" required />
                                <label class="form-label" for="patientDOB">Data di nascita</label>
                                <input id="patientDOB" type="date" class="form-control" required />
                                <label class="form-label" for="patientCode">Codice Sanitario</label>
                                <input id="patientCode" class="form-control" required />
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label" for="specialty">Specialità</label>
                                <select id="specialty" class="form-select">
                                    <option>Ortopedia</option>
                                    <option>Cardiochirurgia</option>
                                    <option>Neurochirurgia</option>
                                    <option>Chirurgia Generale</option>
                                    <option>Urologia</option>
                                </select>
                                <label class="form-label mt-2" for="duration">Durata prevista (min)</label>
                                <input id="duration" type="number" min="30" step="30" value="60" class="form-control" required />
                                <label class="form-label mt-2" for="desiredTime">Ora desiderata</label>
                                <input id="desiredTime" type="time" class="form-control" />
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="description">Descrizione Intervento</label>
                                <textarea id="description" rows="2" class="form-control"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Équipe Chirurgica</label>
                                <div class="row g-2">
                                    <div class="col-6"> Operatore<select id="chirurgo" class="form-select"><option>Dr. Rossi</option><option>Dr. Bianchi</option></select></div>
                                    <div class="col-6">Aiuto<select id="aiuto" class="form-select"><option>Dr. Verdi</option><option>Dr. Neri</option></select></div>
                                    <div class="col-6">Anestesista<select id="anestesista" class="form-select"><option>Dr.ssa Blu</option><option>Dr.ssa Viola</option></select></div>
                                    <div class="col-6">I. Strumentista<select id="strumentista" class="form-select"><option>Sig.ra Rosa</option><option>Sig.ra Gialla</option></select></div>
                                    <div class="col-6">I. Circolante<select id="circolante" class="form-select"><option>Sig. Marrone</option><option>Sig. Celeste</option></select></div>
                                </div>
                            </div>
                            <div class="col-12 d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Aggiungi</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Assegnazioni Équipe</h5>
                        <ul id="teamList" class="list-group list-group-flush"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRAFICI -->
        <div class="row g-3 mt-3">
            <div class="col-md-2"><canvas id="chart1"></canvas></div>
            <div class="col-md-2"><canvas id="chart2"></canvas></div>
            <div class="col-md-2"><canvas id="chart3"></canvas></div>
            <div class="col-md-2"><canvas id="chart4"></canvas></div>
            <div class="col-md-2"><canvas id="chart5"></canvas></div>
        </div>
    </div>

    <!-- Drawer Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="caseDrawer">
        <div class="offcanvas-header">
            <h5 id="caseDrawerLabel">Dettaglio Intervento</h5>
            <button class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <p><b>Paziente:</b> <span id="drawerPatient"></span></p>
            <p><b>Specialità:</b> <span id="drawerSpec"></span></p>
            <p>
                <b>Équipe:</b><br>
                Chirurgo: <span id="eqChirurgo"></span><br>
                Aiuto: <span id="eqAiuto"></span><br>
                Anestesista: <span id="eqAnest"></span><br>
                Strumentista: <span id="eqStrum"></span><br>
                Circolante: <span id="eqCirc"></span>
            </p>
            <p><b>Descrizione:</b> <span id="drawerDesc"></span></p>

            <h6 class="mt-3">Timeline chirurgica</h6>
            <table class="table table-sm">
                <thead><tr><th>Fase</th><th>Orario</th><th></th></tr></thead>
                <tbody id="timelineBody"></tbody>
            </table>
            <div class="mb-3">
                <label for="drawerProcedure" class="form-label">Intervento eseguito</label>
                <textarea id="drawerProcedure" class="form-control" rows="3" placeholder="Descrivi l'intervento..."></textarea>
                <button id="btnSaveProcedure" class="btn btn-sm btn-primary mt-2">Salva intervento</button>
            </div>
        </div>
        <div class="offcanvas-footer border-top p-3 d-flex gap-2">
            <button class="btn btn-success" id="btnCheckInDrawer">Check-In</button>
            <button class="btn btn-warning" id="btnTimeOutDrawer">Time-Out</button>
            <button class="btn btn-danger" id="btnSignOutDrawer">Sign-Out</button>
            <button class="btn btn-outline-primary ms-auto" id="btnSavePDFDrawer">Salva PDF</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>document.addEventListener("DOMContentLoaded", () => {
            // === DATA ===
            const scheduleBody = document.getElementById("scheduleBody");
            const salas = [1, 2, 3, 4, 5];
            const startHour = 8, endHour = 20, slotDuration = 30;
            const schedule = {}; // schedule.sala1 = [ case | 'cont' | undefined ]
            salas.forEach(s => schedule["sala" + s] = []);

            const timeSlots = [];
            for (let h = startHour; h < endHour; h++) {
                timeSlots.push(String(h).padStart(2, '0') + ":00");
                timeSlots.push(String(h).padStart(2, '0') + ":30");
            }
            timeSlots.push("20:00");

            document.getElementById("dayLabel").textContent = new Date().toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long", year: "numeric" });

            // === TABLE RENDER ===
            function renderTable() {
                scheduleBody.innerHTML = "";
                timeSlots.forEach((t, rowIndex) => {
                    const tr = document.createElement("tr");
                    const th = document.createElement("th");
                    th.textContent = t;
                    th.classList.add("time-cell");
                    tr.appendChild(th);
                    salas.forEach(s => {
                        const td = document.createElement("td");
                        td.dataset.sala = s;
                        td.classList.add("slot");
                        tr.appendChild(td);
                    });
                    scheduleBody.appendChild(tr);
                });
            }
            renderTable();

            // === CASES RENDER ===
            function renderCases() {
                scheduleBody.querySelectorAll("tr").forEach((tr, row) => {
                    tr.querySelectorAll("td.slot").forEach(td => {
                        const sala = td.dataset.sala;
                        const data = schedule["sala" + sala][row];
                        td.innerHTML = "";
                        if (data) {
                            const div = document.createElement("div");
                            if (data === "cont") {
                                div.classList.add("case-cont");
                            } else {
                                div.classList.add("case-block", "case-sala" + sala);
                                div.innerHTML = `
                    <strong>${data.patient.firstName} ${data.patient.lastName}</strong><br>
                    Codice: ${data.patient.code || ""}<br>
                    Nascita: ${data.patient.dob || ""}
                  `;
                                div.onclick = () => showDrawer(data);
                            }
                            td.appendChild(div);
                        }
                    });
                });
                updateKPI();
                populateTeam();
                updateCharts();
            }

            // === FORM SUBMIT ===
            document.getElementById("surgeryForm").addEventListener("submit", e => {
                e.preventDefault();
                const patient = {
                    firstName: document.getElementById("patientFirstName").value.trim(),
                    lastName: document.getElementById("patientLastName").value.trim(),
                    dob: document.getElementById("patientDOB").value.trim(),
                    code: document.getElementById("patientCode").value.trim()
                };
                if (!patient.firstName || !patient.lastName) return alert("Inserisci i dati del paziente");

                const specialty = document.getElementById("specialty").value;
                const duration = parseInt(document.getElementById("duration").value);
                const desired = document.getElementById("desiredTime").value;
                const desc = document.getElementById("description").value.trim();
                const equipe = {
                    chirurgo: document.getElementById("chirurgo").value,
                    aiuto: document.getElementById("aiuto").value,
                    anestesista: document.getElementById("anestesista").value,
                    strumentista: document.getElementById("strumentista").value,
                    circolante: document.getElementById("circolante").value
                };

                const salaMap = { "Ortopedia": 1, "Cardiochirurgia": 2, "Neurochirurgia": 3, "Chirurgia Generale": 4, "Urologia": 5 };
                const sala = salaMap[specialty];
                const slotsNeeded = Math.max(1, Math.floor(duration / slotDuration));

                let startIndex = desired ? timeSlots.indexOf(desired) : 0;
                if (startIndex < 0) startIndex = 0;

                let placed = false;
                for (let i = startIndex; i <= timeSlots.length - slotsNeeded; i++) {
                    let conflict = false;
                    for (let j = 0; j < slotsNeeded; j++) {
                        if (schedule["sala" + sala][i + j]) { conflict = true; break; }
                    }
                    if (!conflict) {
                        const caseObj = { patient, specialty, duration, desc, equipe, timeline: {}, sala, startSlot: i, desiredTime: desired || timeSlots[i], completed: false };
                        for (let j = 0; j < slotsNeeded; j++) {
                            schedule["sala" + sala][i + j] = (j === 0) ? caseObj : "cont";
                        }
                        placed = true;
                        break;
                    }
                }
                if (!placed) return alert("Nessuno slot disponibile");

                e.target.reset();
                renderCases();
            });

            // === CLEAR ALL ===
            document.getElementById("clearAll").addEventListener("click", () => {
                if (!confirm("Sicuro di svuotare la giornata?")) return;
                salas.forEach(s => schedule["sala" + s] = []);
                renderTable();
                renderCases();
            });

            // === DRAWER ===
            const drawerEl = document.getElementById("caseDrawer");
            const drawer = new bootstrap.Offcanvas(drawerEl);
            let currentCase = null;

            function showDrawer(c) {
                currentCase = c;
                document.getElementById("caseDrawerLabel").textContent = `Dettaglio — ${c.patient.firstName} ${c.patient.lastName}`;
                document.getElementById("drawerPatient").textContent = `${c.patient.firstName} ${c.patient.lastName}`;
                document.getElementById("drawerSpec").textContent = c.specialty;
                document.getElementById("drawerDesc").textContent = c.desc || "—";
                document.getElementById("eqChirurgo").textContent = c.equipe.chirurgo;
                document.getElementById("eqAiuto").textContent = c.equipe.aiuto;
                document.getElementById("eqAnest").textContent = c.equipe.anestesista;
                document.getElementById("eqStrum").textContent = c.equipe.strumentista;
                document.getElementById("eqCirc").textContent = c.equipe.circolante;

                const phases = ["Ingresso Blocco", "Verifica Pre-sala", "Ingresso Sala", "Inizio Anestesia", "Incisione", "Ultimo Punto", "Risveglio", "Uscita Sala"];
                const tb = document.getElementById("timelineBody");
                tb.innerHTML = "";
                phases.forEach(ph => {
                    const tr = document.createElement("tr");
                    const td1 = document.createElement("td"); td1.textContent = ph;
                    const td2 = document.createElement("td"); td2.textContent = c.timeline[ph] || "—";
                    const td3 = document.createElement("td");
                    const btn = document.createElement("button");
                    btn.className = "btn btn-sm btn-outline-primary";
                    btn.textContent = "Segna ora";
                    btn.onclick = () => {
                        c.timeline[ph] = new Date().toLocaleTimeString("it-IT");
                        showDrawer(c);
                        renderCases();
                    };
                    td3.appendChild(btn);
                    tr.append(td1, td2, td3);
                    tb.appendChild(tr);
                });

                // Drawer buttons
                document.getElementById("btnCheckInDrawer").onclick = () => { c.checkIn = new Date().toLocaleTimeString("it-IT"); alert("Check-In registrato"); renderCases(); };
                document.getElementById("btnTimeOutDrawer").onclick = () => { c.timeOut = new Date().toLocaleTimeString("it-IT"); alert("Time-Out registrato"); renderCases(); };
                document.getElementById("btnSignOutDrawer").onclick = () => { c.signOut = new Date().toLocaleTimeString("it-IT"); c.completed = true; alert("Sign-Out registrato"); renderCases(); };

                // Procedure
                const procArea = document.getElementById("drawerProcedure");
                procArea.value = c.procedure || "";
                document.getElementById("btnSaveProcedure").onclick = () => {
                    c.procedure = procArea.value;
                    alert("Intervento salvato!");
                };

                // Save PDF
                document.getElementById("btnSavePDFDrawer").onclick = () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text("Registro Chirurgico", 10, 10);
                    doc.text(`Paziente: ${c.patient.firstName} ${c.patient.lastName}`, 10, 20);
                    doc.text(`Specialità: ${c.specialty}`, 10, 28);
                    doc.text(`Intervento programmato: ${c.desc || ""}`, 10, 36);
                    let y = 46;
                    doc.text("Équipe:", 10, y);
                    doc.text(`- Chirurgo: ${c.equipe.chirurgo}`, 15, y + 8);
                    doc.text(`- Aiuto: ${c.equipe.aiuto}`, 15, y + 15);
                    doc.text(`- Anestesista: ${c.equipe.anestesista}`, 15, y + 22);
                    doc.text(`- Strumentista: ${c.equipe.strumentista}`, 15, y + 29);
                    doc.text(`- Circolante: ${c.equipe.circolante}`, 15, y + 36);
                    y += 46;
                    doc.text("Timeline:", 10, y);
                    y += 8;
                    Object.entries(c.timeline).forEach(([ph, t]) => {
                        doc.text(`- ${ph}: ${t}`, 15, y);
                        y += 7;
                    });
                    if (c.procedure && c.procedure.trim() !== "") {
                        y += 5;
                        doc.text("Intervento eseguito:", 10, y);
                        const lines = doc.splitTextToSize(c.procedure, 180);
                        y += 8;
                        doc.text(lines, 15, y);
                    }
                    doc.save(`Registro_${c.patient.lastName || "paziente"}.pdf`);
                };

                drawer.show();
            }

            // === KPI / TEAM / CHARTS ===
            function getAllCases() {
                const cases = [];
                salas.forEach(s => {
                    const arr = schedule["sala" + s];
                    for (let i = 0; i < arr.length; i++) {
                        const c = arr[i];
                        if (c && c !== "cont") cases.push(c);
                    }
                });
                // unique by identity - fine as we only push head blocks
                return cases;
            }

            function updateKPI() {
                const cases = getAllCases();
                const saleOcc = new Set(cases.map(c => c.sala)).size;
                const completati = cases.filter(c => c.completed).length;
                // ritardo: consideriamo in ritardo se l'ora corrente è dopo la desiredTime e non c'è "Ingresso Sala"
                const now = new Date();
                const today = now.toISOString().substring(0, 10);
                function parseTimeToDate(t) {
                    // "HH:MM" -> Date today
                    const d = new Date();
                    const [hh, mm] = t.split(":").map(Number);
                    d.setHours(hh || 0, mm || 0, 0, 0);
                    return d;
                }
                const ritardi = cases.filter(c => c.desiredTime && !c.timeline["Ingresso Sala"] && parseTimeToDate(c.desiredTime) < now).length;
                document.getElementById("kpiSale").textContent = saleOcc + "/5";
                document.getElementById("kpiPazienti").textContent = cases.length.toString();
                document.getElementById("kpiCompletati").textContent = completati.toString();
                document.getElementById("kpiRitardo").textContent = ritardi.toString();
            }

            function populateTeam() {
                const ul = document.getElementById("teamList");
                ul.innerHTML = "";
                getAllCases().forEach(c => {
                    const li = document.createElement("li");
                    li.className = "list-group-item d-flex flex-column";
                    li.innerHTML = `
              <div><span class="person-icon">👤</span><strong>${c.patient.firstName} ${c.patient.lastName}</strong> · <small>Sala ${c.sala}</small></div>
              <div class="mt-1"><small>🧑‍⚕️ ${c.equipe.chirurgo}, 👩‍⚕️ ${c.equipe.anestesista}, 🧰 ${c.equipe.strumentista}, 🔄 ${c.equipe.circolante}</small></div>
            `;
                    ul.appendChild(li);
                });
            }

            // Charts
            const charts = {};
            function salaOccupazione(sala) {
                const totSlots = timeSlots.length;
                const used = (schedule["sala" + sala].filter(Boolean) || []).length;
                return Math.round((used / totSlots) * 100);
            }
            function initCharts() {
                salas.forEach(s => {
                    const ctx = document.getElementById("chart" + s).getContext("2d");
                    charts[s] = new Chart(ctx, {
                        type: "doughnut",
                        data: {
                            labels: ["Occupato", "Libero"],
                            datasets: [{ data: [0, 100] }]
                        },
                        options: { plugins: { title: { display: true, text: "Sala " + s } } }
                    });
                });
            }
            function updateCharts() {
                salas.forEach(s => {
                    const occ = salaOccupazione(s);
                    const chart = charts[s];
                    if (chart) {
                        chart.data.datasets[0].data = [occ, 100 - occ];
                        chart.update();
                    }
                });
            }
            initCharts();

            // Fake sample to visualize (optional, comment out if not needed)
            // const e = new Event("submit"); document.getElementById("patientFirstName").value="Mario"; document.getElementById("patientLastName").value="Rossi"; document.getElementById("patientDOB").value="1970-01-01"; document.getElementById("patientCode").value="RSSMRA70A01H501X"; document.getElementById("specialty").value="Ortopedia"; document.getElementById("duration").value=60; document.getElementById("desiredTime").value="08:00"; document.getElementById("chirurgo").value="Dr. Bianchi"; document.getElementById("aiuto").value="Dr. Verdi"; document.getElementById("anestesista").value="Dr.ssa Blu"; document.getElementById("strumentista").value="Sig.ra Rosa"; document.getElementById("circolante").value="Sig. Celeste"; document.getElementById("surgeryForm").dispatchEvent(e);

        });</script>

    <div align="center"><footer>Legal Copyright 2025 · Stefano Pepe</footer></div>
</body>
</html>
