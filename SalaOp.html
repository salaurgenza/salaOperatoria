<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestione Sale Operatorie — Planner + Workflow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --grid: #e9ecef;
        }

        body {
            background: #f8f9fa;
        }

        .time-cell {
            width: 70px;
            font-weight: 600;
            background: #fdfdfd;
        }

        .slot {
            position: relative;
            height: 40px;
        }

        .case-block {
            position: absolute;
            inset: 2px;
            border-radius: .5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
        }

        .case-cont {
            border: 1px dashed rgba(0,0,0,.2);
            background: rgba(0,0,0,.03);
        }

        .case-sala1 {
            background: rgba(13,110,253,.15);
            border: 1px solid rgba(13,110,253,.4);
            color: #0b3a59;
        }

        .case-sala2 {
            background: rgba(220,53,69,.15);
            border: 1px solid rgba(220,53,69,.4);
            color: #721c24;
        }

        .case-sala3 {
            background: rgba(255,193,7,.15);
            border: 1px solid rgba(255,193,7,.4);
            color: #856404;
        }

        .case-sala4 {
            background: rgba(40,167,69,.15);
            border: 1px solid rgba(40,167,69,.4);
            color: #155724;
        }

        .case-sala5 {
            background: rgba(111,66,193,.15);
            border: 1px solid rgba(111,66,193,.4);
            color: #3d1769;
        }

        .table-sticky thead th {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 2;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid justify-content-between">
            <span class="navbar-brand">Gestione Sale Operatorie · Planner + Workflow</span>
            <span class="text-white-50">Giornata: <span id="dayLabel"></span></span>
        </div>
    </nav>

    <div class="container-fluid py-3">
        <div class="row g-3">
            <!-- Planner -->
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-2">Planning Orario — 08:00 → 20:00</h5>
                        <div class="table-responsive table-sticky">
                            <table class="table table-sm align-middle mb-0" id="scheduleTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Orario</th>
                                        <th data-sala="1">S 1 · Ortopedia</th>
                                        <th data-sala="2">S 2 · Cardioch.</th>
                                        <th data-sala="3">S 3 · Neuroch.</th>
                                        <th data-sala="4">S 4 · Chir. Gen.</th>
                                        <th data-sala="5">S 5 · Urol.</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form -->
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Nuovo Intervento</h5>
                        <form id="surgeryForm" class="row g-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label" for="patientFirstName">Nome Paziente</label>
                                <input id="patientFirstName" class="form-control" required />

                                <label class="form-label" for="patientLastName">Cognome Paziente</label>
                                <input id="patientLastName" class="form-control" required />

                                <label class="form-label" for="patientDOB">Data di nascita</label>
                                <input id="patientDOB" type="date" class="form-control" required />

                                <label class="form-label" for="patientCode">Codice Sanitario</label>
                                <input id="patientCode" class="form-control" required />
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Specialità</label>
                                <select id="specialty" class="form-select">
                                    <option>Ortopedia</option>
                                    <option>Cardiochirurgia</option>
                                    <option>Neurochirurgia</option>
                                    <option>Chirurgia Generale</option>
                                    <option>Urologia</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">Durata prevista (min)</label>
                                <input id="duration" type="number" min="30" step="30" value="60" class="form-control" required />
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">Ora desiderata</label>
                                <input id="desiredTime" type="time" class="form-control" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Descrizione Intervento</label>
                                <textarea id="description" rows="2" class="form-control"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Équipe Chirurgica</label>
                                <div class="row g-2">
                                    <div class="col-6"> Operatore<select id="chirurgo" class="form-select"><option>Dr. Rossi</option><option>Dr. Bianchi</option></select></div>
                                    <div class="col-6">Aiuto<select id="aiuto" class="form-select"><option>Dr. Verdi</option><option>Dr. Neri</option></select></div>
                                    <div class="col-6">Anestesista<select id="anestesista" class="form-select"><option>Dr.ssa Blu</option><option>Dr.ssa Viola</option></select></div>
                                    <div class="col-6">I. Strumentista<select id="strumentista" class="form-select"><option>Sig.ra Rosa</option><option>Sig.ra Gialla</option></select></div>
                                    <div class="col-6">I. Circolante<select id="circolante" class="form-select"><option>Sig. Marrone</option><option>Sig. Celeste</option></select></div>
                                </div>
                            </div>
                            <div class="col-12 d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Aggiungi</button>
                                <button type="button" id="clearAll" class="btn btn-outline-secondary">Svuota giornata</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drawer -->
    

    <div class="offcanvas offcanvas-end" tabindex="-1" id="caseDrawer">
        <div class="offcanvas-header">
            <h5 id="caseDrawerLabel">Dettaglio Intervento</h5>
            <button class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <p><b>Paziente:</b> <span id="drawerPatient"></span></p>
            <p><b>Specialità:</b> <span id="drawerSpec"></span></p>
            <p>
                <b>Équipe:</b><br>
                Chirurgo: <span id="eqChirurgo"></span><br>
                Aiuto: <span id="eqAiuto"></span><br>
                Anestesista: <span id="eqAnest"></span><br>
                Strumentista: <span id="eqStrum"></span><br>
                Circolante: <span id="eqCirc"></span>
            </p>
            <p><b>Descrizione:</b> <span id="drawerDesc"></span></p>

            <h6 class="mt-3">Timeline chirurgica</h6>
            <table class="table table-sm">
                <thead><tr><th>Fase</th><th>Orario</th><th></th></tr></thead>
                <tbody id="timelineBody"></tbody>
            </table>
        </div>
        <div class="offcanvas-footer border-top p-3 d-flex gap-2">
            <button class="btn btn-success" id="btnCheckInDrawer">Check-In</button>
            <button class="btn btn-warning" id="btnTimeOutDrawer">Time-Out</button>
            <button class="btn btn-danger" id="btnSignOutDrawer">Sign-Out</button>
            <button class="btn btn-outline-primary ms-auto" id="btnSavePDFDrawer">Salva PDF</button>
        </div>
        <div class="mb-3">
            <label for="drawerProcedure" class="form-label">Intervento eseguito</label>
            <textarea id="drawerProcedure" class="form-control" rows="3" placeholder="Descrivi l'intervento..."></textarea>
            <button id="btnSaveProcedure" class="btn btn-sm btn-primary mt-2">Salva intervento</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>document.addEventListener("DOMContentLoaded", () => {

            const scheduleBody = document.getElementById("scheduleBody");
            const salas = [1, 2, 3, 4, 5];
            const startHour = 8, endHour = 20, slotDuration = 30;

            const schedule = {};
            salas.forEach(s => schedule["sala" + s] = []);

            const timeSlots = [];
            for (let h = startHour; h < endHour; h++) {
                timeSlots.push(`${String(h).padStart(2, '0')}:00`);
                timeSlots.push(`${String(h).padStart(2, '0')}:30`);
            }
            timeSlots.push("20:00");

            document.getElementById("dayLabel").textContent = new Date().toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long", year: "numeric" });

            function renderTable() {
                scheduleBody.innerHTML = "";
                timeSlots.forEach((t, rowIndex) => {
                    const tr = document.createElement("tr");
                    const th = document.createElement("th");
                    th.textContent = t;
                    th.classList.add("time-cell");
                    tr.appendChild(th);

                    salas.forEach(s => {
                        const td = document.createElement("td");
                        td.dataset.sala = s;
                        td.classList.add("slot");
                        tr.appendChild(td);
                    });

                    scheduleBody.appendChild(tr);
                });
            }
            renderTable();

            document.getElementById("surgeryForm").addEventListener("submit", e => {
                e.preventDefault();

                const patient = {
                    firstName: document.getElementById("patientFirstName").value.trim(),
                    lastName: document.getElementById("patientLastName").value.trim(),
                    dob: document.getElementById("patientDOB").value.trim(),
                    code: document.getElementById("patientCode").value.trim()
                };
                if (!patient.firstName || !patient.lastName) return alert("Inserisci i dati del paziente");

                const specialty = document.getElementById("specialty").value;
                const duration = parseInt(document.getElementById("duration").value);
                const desired = document.getElementById("desiredTime").value;
                const desc = document.getElementById("description").value.trim();
                const equipe = {
                    chirurgo: document.getElementById("chirurgo").value,
                    aiuto: document.getElementById("aiuto").value,
                    anestesista: document.getElementById("anestesista").value,
                    strumentista: document.getElementById("strumentista").value,
                    circolante: document.getElementById("circolante").value
                };

                const salaMap = { "Ortopedia": 1, "Cardiochirurgia": 2, "Neurochirurgia": 3, "Chirurgia Generale": 4, "Urologia": 5 };
                const sala = salaMap[specialty];
                const slotsNeeded = duration / slotDuration;

                let startIndex = desired ? timeSlots.indexOf(desired) : 0;
                if (startIndex < 0) startIndex = 0;

                let placed = false;
                for (let i = startIndex; i <= timeSlots.length - slotsNeeded; i++) {
                    let conflict = false;
                    for (let j = 0; j < slotsNeeded; j++) {
                        if (schedule["sala" + sala][i + j]) conflict = true;
                    }
                    if (!conflict) {
                        for (let j = 0; j < slotsNeeded; j++) {
                            schedule["sala" + sala][i + j] = j === 0 ? { patient, specialty, duration, desc, equipe, timeline: {} } : "cont";
                        }
                        placed = true;
                        break;
                    }
                }

                if (!placed) return alert("Nessuno slot disponibile");

                renderCases();
                e.target.reset();
            });

            // Renderizza i casi in tabella

            function renderCases() {
                scheduleBody.querySelectorAll("tr").forEach((tr, row) => {
                    tr.querySelectorAll("td.slot").forEach(td => {
                        const sala = td.dataset.sala;
                        const data = schedule["sala" + sala][row];
                        td.innerHTML = "";
                        if (data) {
                            const div = document.createElement("div");
                            if (data === "cont") {
                                div.classList.add("case-cont");
                            } else {
                                div.classList.add("case-block", "case-sala" + sala);
                                // Mostra Nome, Cognome, Codice Sanitario, Data di nascita
                                div.innerHTML = `
                            <strong>${data.patient.firstName} ${data.patient.lastName}</strong><br>
                            Codice: ${data.patient.code}<br>
                            Nascita: ${data.patient.dob}
                        `;
                                div.onclick = () => showDrawer(data);
                            }
                            td.appendChild(div);
                        }
                    });
                });
            }


            const drawerEl = document.getElementById("caseDrawer");
            const drawer = new bootstrap.Offcanvas(drawerEl);
            let currentCase = null;

            function showDrawer(c) {
                currentCase = c;
                document.getElementById("caseDrawerLabel").textContent = `Dettaglio — ${c.patient.firstName} ${c.patient.lastName}`;
                document.getElementById("drawerPatient").textContent = `${c.patient.firstName} ${c.patient.lastName}`;
                document.getElementById("drawerSpec").textContent = c.specialty;
                document.getElementById("drawerDesc").textContent = c.desc;
                document.getElementById("eqChirurgo").textContent = c.equipe.chirurgo;
                document.getElementById("eqAiuto").textContent = c.equipe.aiuto;
                document.getElementById("eqAnest").textContent = c.equipe.anestesista;
                document.getElementById("eqStrum").textContent = c.equipe.strumentista;
                document.getElementById("eqCirc").textContent = c.equipe.circolante;

                const phases = ["Ingresso Blocco", "Verifica Pre-sala", "Ingresso Sala", "Inizio Anestesia", "Incisione", "Ultimo Punto", "Risveglio", "Uscita Sala"];
                const tb = document.getElementById("timelineBody");
                tb.innerHTML = "";
                phases.forEach(ph => {
                    const tr = document.createElement("tr");
                    const td1 = document.createElement("td"); td1.textContent = ph;
                    const td2 = document.createElement("td"); td2.textContent = c.timeline[ph] || "—";
                    const td3 = document.createElement("td");
                    const btn = document.createElement("button");
                    btn.className = "btn btn-sm btn-outline-primary";
                    btn.textContent = "Segna ora";
                    btn.onclick = () => {
                        c.timeline[ph] = new Date().toLocaleTimeString("it-IT");
                        showDrawer(c);
                        renderCases(); // Aggiorna anche tabella sala
                    };
                    td3.appendChild(btn);
                    tr.append(td1, td2, td3);
                    tb.appendChild(tr);
                });

                document.getElementById("btnCheckInDrawer").onclick = () => { c.checkIn = new Date().toLocaleTimeString("it-IT"); window.location.href = "checkin.html"; };
                document.getElementById("btnTimeOutDrawer").onclick = () => { c.timeOut = new Date().toLocaleTimeString("it-IT"); alert("Time-Out registrato"); renderCases(); };
                document.getElementById("btnSignOutDrawer").onclick = () => { c.signOut = new Date().toLocaleTimeString("it-IT"); alert("Sign-Out registrato"); renderCases(); };

                document.getElementById("btnSavePDFDrawer").onclick = () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    doc.text("Registro Chirurgico", 10, 10);
                    doc.text(`Paziente: ${c.patient.firstName} ${c.patient.lastName}`, 10, 20);
                    doc.text(`Specialità: ${c.specialty}`, 10, 28);
                    doc.text(`Intervento programmato: ${c.desc}`, 10, 36);

                    // Intervento eseguito
                    if (c.procedure && c.procedure.trim() !== "") {
                        doc.text("Intervento eseguito:", 10, 46);
                        const lines = doc.splitTextToSize(c.procedure, 180);
                        doc.text(lines, 15, 54);
                    }

                    // Posizione dinamica per la sezione Équipe
                    let y = (c.procedure && c.procedure.trim() !== "")
                        ? 54 + (doc.getLineHeight() * doc.splitTextToSize(c.procedure, 180).length) + 6
                        : 46;

                    doc.text("Équipe:", 10, y);
                    doc.text(`- Chirurgo: ${c.equipe.chirurgo}`, 15, y + 8);
                    doc.text(`- Aiuto: ${c.equipe.aiuto}`, 15, y + 15);
                    doc.text(`- Anestesista: ${c.equipe.anestesista}`, 15, y + 22);
                    doc.text(`- Strumentista: ${c.equipe.strumentista}`, 15, y + 29);
                    doc.text(`- Circolante: ${c.equipe.circolante}`, 15, y + 36);

                    doc.save(`Registro_${c.patient.lastName}.pdf`);
                };

                drawer.show();

            }
});
        // Imposta valore se già presente
        document.getElementById("drawerProcedure").value = c.procedure || "";

        // Salva intervento
        document.getElementById("btnSaveProcedure").onclick = () => {
            c.procedure = document.getElementById("drawerProcedure").value;
            alert("Intervento salvato!");
            renderCases(); // aggiorna la tabella se vuoi mostrarlo lì
        };


    </script>
    <div align="center">
        <footer>Legal Copiryght 2025 Stefano Pepe</footer>
    </div>
    <br />
</body>
</html>
